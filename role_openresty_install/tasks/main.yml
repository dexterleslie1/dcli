- systemd:
    name: openresty
    state: stopped
  ignore_errors: yes

- stat: path=/usr/local/openresty
  register: var_openresty_folder
- name: "复制本地文件openresty.tar.gz到部署主机"
  synchronize:
   src: /tmp/openresty.tar.gz
   dest: /usr/local/openresty.tar.gz
  when: not var_openresty_folder.stat.exists
- name: "cd /usr/local && tar zxf openresty.tar.gz"
  shell: cd /usr/local && tar zxf openresty.tar.gz
  when: not var_openresty_folder.stat.exists
- file:
   path: /usr/local/openresty.tar.gz
   state: absent

- name: "复制本地文件openresty.service到部署主机/usr/lib/systemd/system/openresty.service"
  template:
    src: openresty.service
    dest: /usr/lib/systemd/system/openresty.service
- name: "复制本地文件naxsi.rules到部署主机/usr/local/openresty/nginx/conf/naxsi.rules"
  template:
    src: naxsi.rules
    dest: /usr/local/openresty/nginx/conf/naxsi.rules
- name: "复制本地文件nginx.conf到部署主机/usr/local/openresty/nginx/conf/nginx.conf"
  template:
    src: nginx.conf
    dest: /usr/local/openresty/nginx/conf/nginx.conf

- name: "systemctl restart openresty"
  systemd:
    name: openresty
    state: restarted
